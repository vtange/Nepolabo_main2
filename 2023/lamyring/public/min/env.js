window.env = "ENV_RING";
!function(e,n){"use strict";function o(e,n,o){this.fernScene=e,this.scene=e.self,this.BJS=n,this.physicsEnabled=!1,o&&(window.CANNON||window.CannonJSPlugin)&&(this.physicsEnabled=!0)}e.ImportMeshWrapper=o,function(e){function n(e,n,o,t,a,r){var i=["x","y","z"];if(e.position.x=n,e.position.y=o,e.position.z=t,e.rotationQuaternion=null,Array.isArray(a)?(e.rotation.x=a[0]*Math.PI/180,e.rotation.y=a[1]*Math.PI/180,e.rotation.z=a[2]*Math.PI/180):e.rotation.y=a*Math.PI/180,r)for(var s=0;s<i.length;s++)e.scaling[i[s]]*=r}function o(e,n,o){function t(e){var n=!1,o=null;function t(a){var r;n||(a-o>=1e3&&(n=!0),function(n,o){d.currentLoop&&d.currentLoop.setWeightForAllAnimatables(1-n);e&&e.setWeightForAllAnimatables(n);o&&(d.currentLoop=e)}(0+1*(r=(a-o)/1e3,(r*=2)<1?.5*r*r:-.5*(--r*(r-2)-1)),n),requestAnimationFrame(t))}e.setWeightForAllAnimatables(0),window.requestAnimationFrame((function(e){o||(o=e),t(e)}))}function a(e,n,o){i(),e.stopped&&(e.start(!0,1,n,o),e.stopped=!1,t(e))}function r(e,n,o){i(),e.start(!1,1,n,o)}function i(){u.forEach((function(e){e!=d.currentLoop&&e.setWeightForAllAnimatables(0),e.stop(),e.stopped=!0}))}var s=Object.create(null),l=null,u=[],d=Object.create(null),h=!1;if(d.currentLoop=null,e.forEach((function(e){e.stop();var t=o.length?e.name.split(o).pop():e.name;"idle_"===t&&(h=!0),t===n.generateIdleAnimFrom&&(l=e),"_"===e.name[e.name.length-1]?(e.stopped=!0,e.setWeightForAllAnimatables(0),u.push(e),s[e.name]=a.bind(null,e,e.from,e.to)):s[e.name]=r.bind(null,e,e.from,e.to)})),!h&&l){let e=l.clone(),n=0,t=1/30;e.name=o+"idle_",e.stopped=!0,e.setWeightForAllAnimatables(0),u.push(e),s.idle_=a.bind(null,e,n,t,d)}return s}function t(e,n,t,a,r){var i=Object.create(null),s=Object.create(null),l=[],u=[],d=e.getChildMeshes(),h=null,m=r+"~",c=r+"_";var f=e.instantiateHierarchy(null,{doNotInstantiate:!0},(function(e,n){var o=e.material;if(function(e,n){if(i[e.uniqueId]=n.uniqueId,s[n.uniqueId]=n,n.name=r?r+"~"+e.name:"cloneChar_"+Date.now(),n.morphTargetManager){var o=e.morphTargetManager;n.morphTargetManager=o.clone();for(var t=0;t<o.numTargets;t++){let e=o.getTarget(t),n=clonedMesh.morphTargetManager.getTarget(t);i[e.uniqueId]=n.uniqueId,s[n.uniqueId]=n}}}(e,n),n.material&&-1!==o.name.indexOf("FACEMATERIAL")){if(-1===u.indexOf(o)){let e=o.clone(m+o.name);u.push(o),i[o.uniqueId]=e.uniqueId,s[e.uniqueId]=e}"InstancedMesh"!==n.getClassName()&&(n.material=s[i[o.uniqueId]]),h=n.material}}));if(t.forEach((function(e){var n=e.clone(m+e.name);for(var o of(e.overrideMesh&&(n.overrideMesh=s[i[e.overrideMesh.uniqueId]]),d))if(o.skeleton===e&&!o.isAnInstance){let e=s[i[o.uniqueId]];if(e.isAnInstance)continue;if(e.skeleton=n,-1!==l.indexOf(n))continue;for(var t of(l.unshift(n),n.bones))t._linkedTransformNode&&(t._linkedTransformNode=s[i[t._linkedTransformNode.uniqueId]])}})),Array.isArray(a))var p=o(a.map((function(e){return e.clone(c+e.name,(function(e){return s[i[e.uniqueId]]||e}))})),n,c);return{root:f,anims:p,facemat:h,isClone:!0}}function a(e,n,o,t){var a=this.BJS||window.BABYLON,r=(this.BJS?this.BJS.MToonMaterial:null)||window.MToonMaterial,i=this.fernScene,s=Array.isArray(e.instances),l=null,u=e.name?e.name.replace(/_primitive\d+/,""):t.name,d=-1!==n.name.indexOf("FACEMATERIAL"),h=!!t.toonShadeCol&&!d,m=n.name.split("^^");n.name=n instanceof a.PBRCustomMaterial?n.name:"orig@"+t.name+"@"+e.name+"@"+n.name,s&&(e.receiveShadows=!0),h&&!n.useAlphaFromAlbedoTexture&&(i.shadowGen&&(e.receiveShadows=!1),l=new r("m2n<-"+n.name,i.self),n.albedoTexture&&(l.diffuseTexture=n.albedoTexture.clone()),t.toonShadeShift&&(l.shadeShift=t.toonShadeShift),l.cullMode=0,l.outlineWidth=.36,l.outlineWidthMode=2,l.shadeColor=t.toonShadeCol[e.name]?new a.Color3(t.toonShadeCol[e.name][0],t.toonShadeCol[e.name][1],t.toonShadeCol[e.name][2]):new a.Color3(.496,.496,.616),e.material=l,n.dispose()),i.shadowGen&&(o&&(n.unlit=!1),("object"==typeof t.noShadow?t.noShadow[u]:t.noShadow)||i.shadowGen.addShadowCaster(e));var c=null;return t.unlit||d?n.unlit=!0:a.PBRCustomMaterial&&s&&!t.toonShadeCol&&(c=new a.PBRCustomMaterial("cst<-"+n.name,i.self),n.albedoTexture&&(c.albedoTexture=n.albedoTexture.clone()),n.bumpTexture&&(c.bumpTexture=n.bumpTexture.clone()),c.metallic=m[1]?parseFloat(m[1]):.38,c.roughness=m[2]?parseFloat(m[2]):1,c.metallic>=.8&&(c.sheen.isEnabled=!0),c.AddUniform("shadeColor","vec3"),c.AddUniform("shadeColor2","vec3"),t.dblSided&&(c.backFaceCulling=!1),n.useAlphaFromAlbedoTexture&&(c.useAlphaFromAlbedoTexture=!0,t.dblSided?c.transparencyMode=a.Material.MATERIAL_ALPHATEST:(c.transparencyMode=a.Material.MATERIAL_ALPHATESTANDBLEND,c.sheen.linkSheenWithAlbedo=!0,c.sheen.intensity=.4,c.sheen.isEnabled=!0)),n.emissiveTexture&&(c.emissiveTexture=n.emissiveTexture.clone(),c.emissiveIntensity=n.emissiveIntensity,c.emissiveColor=n.emissiveColor),n.ambientTexture?(c.lightmapTexture=n.ambientTexture.clone(),c.ambientTexture&&c.ambientTexture.dispose(),c.Fragment_Before_FragColor("                    vec3 maxdark = mix(shadeColor.rgb, baseColor.rgb, .618);                    finalColor.rgb = max(maxdark.rgb, finalColor.rgb * (shadeColor2.rgb+0.2));                    ")):c.Fragment_Before_FragColor("                    vec3 maxdark = mix(shadeColor.rgb, baseColor.rgb, .618);                    finalColor.rgb = max(maxdark.rgb, finalColor.rgb * 2.);                    "),c.onBindObservable.add((function(){c.getEffect().setColor3("shadeColor",i.self.ambientColor),c.getEffect().setColor3("shadeColor2",i.lighting[0].diffuse)})),e.material=c,n.dispose()),d}e.prototype.applyMeshPositions=function(e,o,t){var a;if(e.length>1){for(var r=0;r<e.length;r++)this.createInstanceAt(o,t,e[r]);o.isVisible=!1,o.getChildMeshes().forEach((function(e){e.isVisible=!1}))}else n(o,(a=e[0])[0][0],a[0][1],a[0][2],a[1],a[2])},e.prototype.createInstanceAt=function(e,o,t){var a=this.BJS||window.BABYLON,r=this.fernScene,i=e.geometry?[e]:e.getChildMeshes(),s=Date.now(),l=new a.TransformNode(o.name+"_tfNode_"+s);l.scaling.z*=-1;for(var u=null,d=0;d<i.length;d++)(u=i[d].createInstance(d.name+"_inst_"+s))&&(u.scaling=i[d].scaling.clone(),i.length>1?u.position=i[d].position.clone():(u.position.x=0,u.position.y=0,u.position.z=0),i[d].rotationQuaternion?u.rotationQuaternion=i[d].rotationQuaternion.clone():u.rotation=i[d].rotation.clone(),u.parent=l,Array.isArray(t)&&n(l,t[0][0],t[0][1],t[0][2],t[1],t[2]),r.shadowGen&&!o.noShadow&&r.shadowGen.addShadowCaster(u));return l},e.prototype.loadMeshes=function(e,n){var o=[];for(var t in e.furns){var a=n[t],r=this.ImportMesh(a);r.then(function(o,t){this.applyMeshPositions(e.furns[o],t.root,n[o])}.bind(this,t)),o.push(r)}return{promiseChain:o}},e.prototype.ImportMesh=function(e){var n=this.BJS||window.BABYLON,r=this.scene,i=this;return new Promise((function(s,l){n.SceneLoader.ImportMesh(e.nodes.length>1?e.nodes:e.nodes[0],e.path[0],e.path[1],r,(function(u,d,h,m){var c=null,f=null,p=[],g=[],b=e.isCollisionMesh,A=e.isNavMesh,C=e.mustCatchShadows;if(!u.length)return console.log("failed to load model: ",e.nodes,e.path[0],e.path[1]),void l();u.forEach((function(o){-1!=o.name.indexOf("root")&&(o.rotationQuaternion=null,o.rotation.x=0,o.rotation.y=0,o.rotation.z=0,c=o),o.geometry&&(g.push(o),i.physicsEnabled&&b&&(o.isVisible=!1,r.mapImpostor=o.physicsImpostor=new n.PhysicsImpostor(o,n.PhysicsImpostor.MeshImpostor,{mass:0,restitution:1,ignoreParent:!0},r))),o.material&&(a.call(i,o,o.material,C,e)&&(f=o.material),p.push(o.material))})),C||b||A?s({manifest:e,anims:m,mats:p,facemat:f,meshes:u,root:c}):(!p.length>1&&(c=g[0]),c.rotationQuaternion=null,c.rotation.x=0,c.rotation.y=0,c.rotation.z=0,c.name="__root_"+e.name,s({manifest:e,anims:h.length?o(m,e,""):Object.create(null),mats:p,facemat:f,root:c,isClone:!1,arrCharNames:[],newCharOrMeshInstance:h.length?t.bind(i,c,e,h,m):i.createInstanceAt.bind(i,c,e)}))}))}))}}(o),"object"==typeof exports?(void 0!==module&&module.exports&&(exports=module.exports=o),exports.ImportMeshWrapper=o,module.exports=exports=o):"function"==typeof define&&define.amd&&define((function(){return o}))}("object"==typeof window&&window||this);